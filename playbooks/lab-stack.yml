---
- name: Lab stack on Fedora (Quarto + Git + Docker)
  hosts: localhost
  connection: local
  become: true

  vars_files:
    - ../host_vars/localhost.yml

  vars:
    base_packages:
      - git
      - curl
      - wget
      - ca-certificates
      - tar
      - unzip
      - python3
      - python3-pip
      - dnf-plugins-core

    # Docker Engine (official packages, not Fedora's moby/podman defaults)
    docker_packages:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin

    quarto_version: "1.6.42"     # pin a version for reproducibility; bump intentionally
    quarto_install_dir: "/opt/quarto"
    quarto_tarball: "quarto-{{ quarto_version }}-linux-amd64.tar.gz"
    quarto_url: "https://github.com/quarto-dev/quarto-cli/releases/download/v{{ quarto_version }}/{{ quarto_tarball }}"

  tasks:
    - name: Install baseline packages
      ansible.builtin.dnf:
        name: "{{ base_packages }}"
        state: present
        update_cache: true

    - name: Remove podman-docker (conflicts with Docker CE CLI)
      ansible.builtin.dnf:
        name: podman-docker
        state: absent

    # ---- Docker Engine from Docker repo (recommended by Docker) ----
    - name: Add Docker CE repo
      ansible.builtin.command: dnf config-manager addrepo --from-repofile https://download.docker.com/linux/fedora/docker-ce.repo
      args:
        creates: /etc/yum.repos.d/docker-ce.repo

    - name: Install Docker Engine packages
      ansible.builtin.dnf:
        name: "{{ docker_packages }}"
        state: present
        update_cache: true

    - name: Enable and start Docker service
      ansible.builtin.systemd:
        name: docker
        enabled: true
        state: started

    - name: Ensure docker group exists
      ansible.builtin.group:
        name: docker
        state: present

    - name: Add lab user to docker group
      ansible.builtin.user:
        name: "{{ lab_user.name }}"
        groups: docker
        append: true

    - name: Configure Git identity (global)
      become: false
      block:
        - name: git push.autoSetupRemote
          community.general.git_config:
            name: push.autoSetupRemote
            scope: global
            value: "true"
 
    # ---- Quarto install (tarball -> /opt/quarto) ----
    - name: Create quarto install directory
      ansible.builtin.file:
        path: "{{ quarto_install_dir }}"
        state: directory
        mode: "0755"

    - name: Download Quarto tarball
      ansible.builtin.get_url:
        url: "{{ quarto_url }}"
        dest: "/tmp/{{ quarto_tarball }}"
        mode: "0644"

    - name: Unpack Quarto to /opt
      ansible.builtin.unarchive:
        src: "/tmp/{{ quarto_tarball }}"
        dest: "/opt"
        remote_src: true

    - name: Symlink /opt/quarto -> extracted folder
      ansible.builtin.file:
        src: "/opt/quarto-{{ quarto_version }}"
        dest: "{{ quarto_install_dir }}"
        state: link
        force: true

    - name: Add Quarto to system PATH
      ansible.builtin.copy:
        dest: /etc/profile.d/quarto.sh
        mode: "0644"
        content: |
          export PATH={{ quarto_install_dir }}/bin:$PATH

    - name: Import Google Linux signing key (RPM)
      ansible.builtin.rpm_key:
        state: present
        key: https://dl.google.com/linux/linux_signing_key.pub

    - name: Add Google Chrome yum repo
      ansible.builtin.yum_repository:
        name: google-chrome
        description: google-chrome
        baseurl: https://dl.google.com/linux/chrome/rpm/stable/x86_64
        enabled: true
        gpgcheck: true
        gpgkey: https://dl.google.com/linux/linux_signing_key.pub

    - name: Install Google Chrome
      ansible.builtin.dnf:
        name: "google-chrome-stable"
        state: present
        update_cache: true

    # --- gitk ---
    - name: Install gitk
      ansible.builtin.dnf:
        name: gitk
        state: present

    # --- ownCloud client (prefer dnf, fallback to Flatpak) ---
    - name: Try to install ownCloud client via dnf
      ansible.builtin.dnf:
        name: owncloud-client
        state: present
      register: owncloud_dnf
      failed_when: false

    - name: Ensure Flatpak is installed (fallback path)
      ansible.builtin.dnf:
        name: flatpak
        state: present
      when: owncloud_dnf is failed

    - name: Ensure Flathub remote exists (fallback path)
      community.general.flatpak_remote:
        name: flathub
        state: present
        flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
      when: owncloud_dnf is failed

    - name: Install ownCloud client via Flatpak (fallback path)
      community.general.flatpak:
        name: com.owncloud.desktopclient.ownCloud
        state: present
      when: owncloud_dnf is failed

    # ---- Thunderbird (dnf if available, otherwise Flatpak) ----
    - name: Try to install Thunderbird via dnf
      ansible.builtin.dnf:
        name: thunderbird
        state: present
      register: thunderbird_dnf
      failed_when: false

    - name: Ensure Flathub remote exists (Thunderbird fallback)
      community.general.flatpak_remote:
        name: flathub
        state: present
        flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
      when: thunderbird_dnf is failed

    - name: Install Thunderbird via Flatpak (fallback)
      community.general.flatpak:
        name: org.mozilla.Thunderbird
        state: present
      when: thunderbird_dnf is failed
