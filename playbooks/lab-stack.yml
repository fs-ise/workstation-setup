---
- name: Lab stack on Fedora
  hosts: localhost
  connection: local
  become: true

  vars_files:
    - ../host_vars/localhost.yml

  vars:
    remove_system_sounds: true

    # Use the user who invoked sudo/ansible (important because play has become: true)
    target_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
    target_home: "{{ lookup('ansible.builtin.env', 'HOME') if (ansible_env.SUDO_USER is not defined) else '/home/' + target_user }}"

    base_packages:
      - git
      - curl
      - wget
      - ca-certificates
      - tar
      - unzip
      - python3
      - python3-pip
      - dnf-plugins-core

    # Docker Engine (official packages, not Fedora's moby/podman defaults)
    docker_packages:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin

    quarto_version: "1.6.42"     # pin a version for reproducibility; bump intentionally
    quarto_install_dir: "/opt/quarto"
    quarto_tarball: "quarto-{{ quarto_version }}-linux-amd64.tar.gz"
    quarto_url: "https://github.com/quarto-dev/quarto-cli/releases/download/v{{ quarto_version }}/{{ quarto_tarball }}"

    # VS Code (vars)
    vscode_repo_name: "vscode"
    vscode_rpm_package: "code"
    vscode_flatpak_id: "com.visualstudio.code"

    # ---- VirtualBox (hard-coded) ----
    virtualbox_repo_url: "https://download.virtualbox.org/virtualbox/rpm/fedora/virtualbox.repo"
    virtualbox_gpgkey_url: "https://www.virtualbox.org/download/oracle_vbox_2016.asc"
    virtualbox_package: "VirtualBox-7.0"
    virtualbox_build_deps:
      - gcc
      - make
      - perl
      - kernel-devel
      - kernel-headers
      - elfutils-libelf-devel

    ocrmypdf_packages_required:
      - ocrmypdf
      - tesseract
      - tesseract-osd
      - tesseract-langpack-eng
      - tesseract-langpack-deu

    ocrmypdf_packages_optional:
      - jbig2enc
      - jbig2enc-devel
      - jbig2

    ocrmypdf_nautilus_action_install: true
    ocrmypdf_nautilus_action_name: "OCR PDF (ocrmypdf)"

    ocrmypdf_nemo_action_install: true
    ocrmypdf_nemo_action_name: "OCR PDF (ocrmypdf)"

    remove_packages_best_effort:
      - deja-dup
      - aisleriot
      - evolution
      - nautilus-share
      - gnome-mahjongg
      - gnome-maps
      - gnome-mines
      - orca
      - gnome-sudoku
      - gnome-weather
      - transmission
      - gnome-tour
      - gnome-contacts
      - gnome-characters
      - gnome-connections
      - gnome-font-viewer
      - gnome-calendar
      - brasero
      - cheese
      - vino
      - simple-scan
      - shotwell
      - gnome-todo
      - telnet
      - malcontent
      - malcontent-control

    install_packages_best_effort:
      - gimp
      - openssh-clients
      - openssh-server
      - gnome-commander
      - audacity
      - recoll
      - libxslt
      - texstudio
      - texlive-scheme-full
      - texlive-latex-extra
      - texlive-xetex
      - texlive-lang-german
      - gitk
      - git-lfs
      - vim
      - clamav
      - python3-tkinter
      - pwgen
      - ruby
      - rubygem-bundler
      - xsel
      - diffpdf
      - dictd
      - dict-gcide
      - dict-wn
      - autokey-gtk
      - hplip
      - hplip-gui
      - gnome-clocks
      - artha
      - xournalpp
      - poppler-utils
      - wv
      - catdoc
      - perl-librdf
      - unrtf
      - untex
      - unifont-fonts
      - obs-studio
      - nextcloud-client
      - keepassxc
      - flatpak
      - pdfarranger
      - nemo
      - nemo-fileroller
      - gnome-terminal
      - borgbackup

    # Docker images to pull
    docker_images:
      - jbarlow83/ocrmypdf
      - rocker/tidyverse
      - rocker/verse
      - python:3
      - alekzonder/puppeteer
      - lfoppiano/grobid:0.8.1

  tasks:
    - name: Install baseline packages
      ansible.builtin.dnf:
        name: "{{ base_packages }}"
        state: present
        update_cache: true

    - name: Install OCRmyPDF + Tesseract + OSD (required)
      ansible.builtin.dnf:
        name: "{{ ocrmypdf_packages_required }}"
        state: present
        update_cache: true

    - name: Install optional JBIG2 encoder packages (best effort)
      ansible.builtin.dnf:
        name: "{{ ocrmypdf_packages_optional }}"
        state: present
      failed_when: false

    - name: Ensure user-local bin dir exists
      ansible.builtin.file:
        path: "/home/{{ target_user }}/.local/bin"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0755"

    - name: Ensure user cache dir exists for wrapper logs
      ansible.builtin.file:
        path: "/home/{{ target_user }}/.cache"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0755"

    - name: Install OCRmyPDF wrapper script (Fedora tessdata dir, interactive feedback + logging)
      ansible.builtin.copy:
        dest: "/home/{{ target_user }}/.local/bin/ocrmypdf-wrapper"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0755"
        content: |
          #!/usr/bin/env bash
          set -euo pipefail

          LOG="${HOME}/.cache/ocrmypdf-wrapper.log"
          mkdir -p "$(dirname "$LOG")"

          interactive=0
          if [[ -t 1 ]]; then interactive=1; fi

          log() { echo "$*" >>"$LOG"; }
          say() { if [[ "$interactive" -eq 1 ]]; then echo "$*"; fi; }

          log "=== $(date -u +"%Y-%m-%dT%H:%M:%SZ") ==="
          log "PWD=$(pwd)"
          log "UID=$(id -u) USER=${USER} ARGS=$*"

          # IMPORTANT:
          # Set to the directory that *contains* eng.traineddata/deu.traineddata,
          # otherwise tesseract reports languages as 'tessdata/eng' and ocrmypdf won't match 'eng'.
          export TESSDATA_PREFIX="/usr/share/tesseract/tessdata"
          log "TESSDATA_PREFIX=${TESSDATA_PREFIX}"

          if command -v tesseract >/dev/null 2>&1; then
            (tesseract --list-langs || true) | head -n 80 | sed 's/^/[tesseract] /' >>"$LOG"
          else
            log "[tesseract] not found in PATH"
          fi

          if [[ $# -eq 0 ]]; then
            log "No arguments provided"
            say "No input file."
            exit 2
          fi

          for infile in "$@"; do
            [[ -n "$infile" ]] || continue

            if [[ ! -f "$infile" ]]; then
              log "Skipping (not a file): $infile"
              say "Skipping (not a file): $infile"
              continue
            fi

            shopt -s nocasematch
            if [[ ! "$infile" =~ \.pdf$ ]]; then
              log "Skipping (not a PDF): $infile"
              say "Skipping (not a PDF): $infile"
              shopt -u nocasematch
              continue
            fi
            shopt -u nocasematch

            out="${infile%.[Pp][Dd][Ff]}_ocr.pdf"

            say "OCR: $(basename "$infile") → $(basename "$out") (can take a while)"
            log "Running: ocrmypdf -l deu+eng --optimize 3 --deskew --rotate-pages --skip-text \"$infile\" \"$out\""

            ocrmypdf -l deu+eng --optimize 3 --deskew --rotate-pages --skip-text "$infile" "$out" >>"$LOG" 2>&1

            if [[ -f "$out" ]]; then
              say "Done: $(basename "$out")"
              log "Wrote: $out"
            else
              say "Failed (no output). Check log: $LOG"
              log "Expected output not found: $out"
              exit 3
            fi
          done

    - name: Ensure Nautilus file-manager actions dir exists
      ansible.builtin.file:
        path: "/home/{{ target_user }}/.local/share/file-manager/actions"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0755"
      when: ocrmypdf_nautilus_action_install | bool

    - name: Install Nautilus right-click action (.desktop)
      ansible.builtin.copy:
        dest: "/home/{{ target_user }}/.local/share/file-manager/actions/ocrmypdf.desktop"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0644"
        content: |
          [Desktop Entry]
          Type=Action
          Name={{ ocrmypdf_nautilus_action_name }}
          Icon=accessories-text-editor
          Profiles=profile-zero;

          [X-Action-Profile profile-zero]
          MimeTypes=application/pdf;
          Exec=/home/{{ target_user }}/.local/bin/ocrmypdf-wrapper "%f"
      when: ocrmypdf_nautilus_action_install | bool

    - name: Restart Nautilus so the action appears (best effort)
      become_user: "{{ target_user }}"
      ansible.builtin.command: nautilus -q
      changed_when: false
      failed_when: false
      when: ocrmypdf_nautilus_action_install | bool

    - name: Ensure Nemo actions dir exists
      ansible.builtin.file:
        path: "/home/{{ target_user }}/.local/share/nemo/actions"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0755"
      when: ocrmypdf_nemo_action_install | bool

    - name: Install Nemo right-click action (.nemo_action) (multi-file safe)
      ansible.builtin.copy:
        dest: "/home/{{ target_user }}/.local/share/nemo/actions/ocrmypdf.nemo_action"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0644"
        content: |
          [Nemo Action]
          Name={{ ocrmypdf_nemo_action_name }}
          Comment=Run OCR on one or more selected PDFs and write *_ocr.pdf next to the originals
          Exec=/home/{{ target_user }}/.local/bin/ocrmypdf-wrapper %F
          Icon-Name=accessories-text-editor
          Selection=any
          Extensions=pdf;
      when: ocrmypdf_nemo_action_install | bool

    - name: Restart Nemo so the action appears (best effort)
      become_user: "{{ target_user }}"
      ansible.builtin.command: nemo -q
      changed_when: false
      failed_when: false
      when: ocrmypdf_nemo_action_install | bool

    # ---- VirtualBox (Oracle repo) ----
    - name: Import Oracle VirtualBox signing key (RPM)
      ansible.builtin.rpm_key:
        state: present
        key: "https://www.virtualbox.org/download/oracle_vbox_2016.asc"

    - name: Add VirtualBox yum repo (Oracle)
      ansible.builtin.get_url:
        url: "https://download.virtualbox.org/virtualbox/rpm/fedora/virtualbox.repo"
        dest: /etc/yum.repos.d/virtualbox.repo
        mode: "0644"

    # Remove Fedora-provided VirtualBox variants that conflict with Oracle packages
    - name: Remove conflicting VirtualBox packages (best effort)
      ansible.builtin.dnf:
        name:
          - VirtualBox-server
          - VirtualBox
          - virtualbox
          - virtualbox-guest-additions
          - virtualbox-guest-additions-iso
        state: absent
      failed_when: false

    - name: Install VirtualBox build dependencies (kernel modules)
      ansible.builtin.dnf:
        name:
          - gcc
          - make
          - perl
          - kernel-devel
          - kernel-headers
          - elfutils-libelf-devel
        state: present
        update_cache: true

    # ---- VirtualBox (Fedora-native) ----
    - name: Ensure VirtualBox packages are installed (Fedora)
      ansible.builtin.dnf:
        name:
          - VirtualBox
          - VirtualBox-server
          - kernel-devel
          - kernel-headers
        state: present
        update_cache: true

    - name: Ensure vboxusers group exists
      ansible.builtin.group:
        name: vboxusers
        state: present

    - name: Add invoking user to vboxusers group
      ansible.builtin.user:
        name: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
        groups: vboxusers
        append: true

    - name: Enable and start vboxdrv service if present (best effort)
      ansible.builtin.systemd:
        name: vboxdrv
        enabled: true
        state: started
      failed_when: false

    - name: Note about VirtualBox
      ansible.builtin.debug:
        msg:
          - "You may need to log out/in for vboxusers group membership to apply."
          - "After kernel updates, reboot so the matching modules load."
          - "If Secure Boot is enabled, VirtualBox kernel modules may require signing or Secure Boot disabled."

    # ---- VirtualBox kernel modules (akmods) ----
    - name: Install akmods for VirtualBox + matching kernel-devel
      ansible.builtin.dnf:
        name:
          - akmod-VirtualBox
          - "kernel-devel-{{ ansible_kernel }}"
        state: present
        update_cache: true
      failed_when: false

    - name: Build VirtualBox kernel modules (akmods)
      ansible.builtin.command: akmods --force
      register: akmods_result
      changed_when: false
      failed_when: false

    - name: Restart vboxdrv service (best effort)
      ansible.builtin.systemd:
        name: vboxdrv
        state: restarted
        enabled: true
      failed_when: false


    # ---- Remove “unwanted” packages ----
    - name: Remove unwanted packages
      ansible.builtin.dnf:
        name: "{{ item }}"
        state: absent
      loop: "{{ remove_packages_best_effort }}"
      register: remove_pkgs_result
      failed_when: false

    # ---- Install “wanted” packages ----
    - name: Install desired packages
      ansible.builtin.dnf:
        name: "{{ item }}"
        state: present
      loop: "{{ install_packages_best_effort }}"
      register: install_pkgs_result
      failed_when: false

    # ---- Docker: avoid conflicts with docker CLI shim from Podman ----
    - name: Remove podman-docker (conflicts with Docker CE CLI)
      ansible.builtin.dnf:
        name: podman-docker
        state: absent
      failed_when: false

    # ---- Docker Engine from Docker repo ----
    - name: Add Docker CE repo
      ansible.builtin.command: dnf config-manager addrepo --from-repofile https://download.docker.com/linux/fedora/docker-ce.repo
      args:
        creates: /etc/yum.repos.d/docker-ce.repo

    - name: Install Docker Engine packages
      ansible.builtin.dnf:
        name: "{{ docker_packages }}"
        state: present
        update_cache: true

    - name: Enable and start Docker service
      ansible.builtin.systemd:
        name: docker
        enabled: true
        state: started

    - name: Ensure docker group exists
      ansible.builtin.group:
        name: docker
        state: present

    - name: Add lab user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        groups: docker
        append: true

    - name: Note about docker group membership
      ansible.builtin.debug:
        msg: "You may need to log out/in (or run: newgrp docker) for docker without sudo."

    # ---- Git config (kept minimal as in your playbook) ----
    - name: Configure Git identity (global)
      become: false
      block:
        - name: git push.autoSetupRemote
          community.general.git_config:
            name: push.autoSetupRemote
            scope: global
            value: "true"

    - name: Set Vim as default Git editor
      become: false
      community.general.git_config:
        name: core.editor
        scope: global
        value: "vim"

    # ---- Quarto install (tarball -> /opt/quarto) ----
    - name: Remove /opt/quarto if it exists as a directory (to allow symlink)
      ansible.builtin.file:
        path: "{{ quarto_install_dir }}"
        state: absent
      when: quarto_install_dir is defined

    - name: Download Quarto tarball
      ansible.builtin.get_url:
        url: "{{ quarto_url }}"
        dest: "/tmp/{{ quarto_tarball }}"
        mode: "0644"

    - name: Unpack Quarto to /opt
      ansible.builtin.unarchive:
        src: "/tmp/{{ quarto_tarball }}"
        dest: "/opt"
        remote_src: true

    - name: Symlink /opt/quarto -> extracted folder
      ansible.builtin.file:
        src: "/opt/quarto-{{ quarto_version }}"
        dest: "{{ quarto_install_dir }}"
        state: link
        force: true

    - name: Add Quarto to system PATH
      ansible.builtin.copy:
        dest: /etc/profile.d/quarto.sh
        mode: "0644"
        content: |
          export PATH={{ quarto_install_dir }}/bin:$PATH

    # ---- Chrome (official repo) ----
    - name: Import Google Linux signing key (RPM)
      ansible.builtin.rpm_key:
        state: present
        key: https://dl.google.com/linux/linux_signing_key.pub

    - name: Add Google Chrome yum repo
      ansible.builtin.yum_repository:
        name: google-chrome
        description: google-chrome
        baseurl: https://dl.google.com/linux/chrome/rpm/stable/x86_64
        enabled: true
        gpgcheck: true
        gpgkey: https://dl.google.com/linux/linux_signing_key.pub

    - name: Install Google Chrome
      ansible.builtin.dnf:
        name: google-chrome-stable
        state: present
        update_cache: true

    # ---- VS Code (Microsoft RPM repo, fallback to Flatpak) ----
    - name: Import Microsoft signing key (RPM)
      ansible.builtin.rpm_key:
        state: present
        key: https://packages.microsoft.com/keys/microsoft.asc

    - name: Add VS Code yum repo
      ansible.builtin.yum_repository:
        name: "{{ vscode_repo_name }}"
        description: "Visual Studio Code"
        baseurl: https://packages.microsoft.com/yumrepos/vscode
        enabled: true
        gpgcheck: true
        gpgkey: https://packages.microsoft.com/keys/microsoft.asc

    - name: Try to install VS Code via dnf
      ansible.builtin.dnf:
        name: "{{ vscode_rpm_package }}"
        state: present
        update_cache: true
      register: vscode_dnf
      failed_when: false

    - name: Install VS Code via Flatpak (fallback)
      community.general.flatpak:
        name: "{{ vscode_flatpak_id }}"
        state: present
      when: vscode_dnf is failed


    - name: Set VS Code as default editor for common text formats
      become: false
      ansible.builtin.shell: |
        xdg-mime default code.desktop text/plain
        xdg-mime default code.desktop text/markdown
        xdg-mime default code.desktop text/x-python
        xdg-mime default code.desktop application/x-quarto


    # ---- Flatpak + Flathub (needed for reliable Thunderbird fallback) ----
    - name: Ensure Flathub remote exists
      community.general.flatpak_remote:
        name: flathub
        state: present
        flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo

    - name: Install GnuPG and pinentry on Fedora
      become: true
      ansible.builtin.dnf:
        name:
          - gnupg2
          - pinentry
        state: present
        update_cache: true

    # Install Dropbox
    - name: Enable RPM Fusion free repository
      ansible.builtin.dnf:
        name:
          - "https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_facts.distribution_major_version }}.noarch.rpm"
        state: present

    - name: Enable RPM Fusion nonfree repository
      ansible.builtin.dnf:
        name:
          - "https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ ansible_facts.distribution_major_version }}.noarch.rpm"
        state: present

    - name: Install Dropbox (client daemon)
      ansible.builtin.dnf:
        name:
          - dropbox
        state: present
        update_cache: true

    # Optional (GNOME Files / Nautilus integration). If you don't use GNOME Files, skip this.
    - name: Install Nautilus Dropbox integration (optional)
      ansible.builtin.dnf:
        name:
          - nautilus-dropbox
        state: present
      when: ansible_facts.env.XDG_CURRENT_DESKTOP is defined and
            ('GNOME' in ansible_facts.env.XDG_CURRENT_DESKTOP)


    # ---- Thunderbird (dnf if available, otherwise Flatpak) ----
    - name: Try to install Thunderbird via dnf
      ansible.builtin.dnf:
        name: thunderbird
        state: present
      register: thunderbird_dnf
      failed_when: false

    - name: Install Thunderbird via Flatpak (fallback)
      community.general.flatpak:
        name: org.mozilla.Thunderbird
        state: present
      when: thunderbird_dnf is failed

    - name: Install Obsidian (Flatpak)
      community.general.flatpak:
        name: md.obsidian.Obsidian
        state: present

    - name: Ensure Nemo desktop file exists (sanity check)
      ansible.builtin.stat:
        path: /usr/share/applications/nemo.desktop
      register: nemo_desktop

    - name: Set Nemo as default handler for directories (xdg-mime)
      become: false
      ansible.builtin.command: xdg-mime default nemo.desktop inode/directory
      when: nemo_desktop.stat.exists
      changed_when: false

    - name: Set Nemo as default handler for folder scheme (xdg-mime)
      become: false
      ansible.builtin.command: xdg-mime default nemo.desktop x-scheme-handler/file
      when: nemo_desktop.stat.exists
      changed_when: false

    - name: Create custom keybinding to open Nemo (Super+E)
      become: false
      ansible.builtin.shell: |
        gsettings set org.gnome.settings-daemon.plugins.media-keys custom-keybindings "['/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/']"
        gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/ name 'Files (Nemo)'
        gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/ command 'nemo'
        gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/ binding '<Super>e'
      args:
        executable: /bin/bash
      changed_when: false

    # ---- Nemo sane defaults (list view, sorting, dates) ----
    - name: Configure Nemo preferences
      become: false
      vars:
        nemo_settings:
          - { key: "sort-directories-first", value: "true" }
          - { key: "default-sort-order", value: "'name'" }
          - { key: "default-sort-in-reverse-order", value: "false" }
          - { key: "show-full-path-titles", value: "true" }
          - { key: "default-folder-viewer", value: "'list-view'" }
      ansible.builtin.command: >
        gsettings set org.nemo.preferences {{ item.key }} {{ item.value }}
      loop: "{{ nemo_settings }}"
      changed_when: false


    # ---- Optional: remove system sounds (destructive) ----
    - name: Remove system sounds (/usr/share/sounds) - optional and destructive
      ansible.builtin.file:
        path: /usr/share/sounds
        state: absent
      when: remove_system_sounds | bool

    # ---- Docker pulls ----
    - name: Pull docker images
      ansible.builtin.command: "docker pull {{ item }}"
      loop: "{{ docker_images }}"
      register: docker_pull_result
      changed_when: false

    # ---- GUI-session-only items ----
    - name: Mouse speed note (xset requires an active X/Wayland session)
      ansible.builtin.debug:
        msg: "Mouse speed change (xset m 2/1 10) is session-specific; do it in your desktop session, not via Ansible."

    - name: Remove default media dirs in home if empty
      become: false
      vars:
        target_user: "{{ lab_user.name | default(ansible_user_id) }}"
        media_dirs: [Music, Pictures, Videos]
      block:
        - name: Check whether each dir exists
          ansible.builtin.stat:
            path: "/home/{{ target_user }}/{{ item }}"
          loop: "{{ media_dirs }}"
          register: media_stat

        - name: Count entries inside each dir (including hidden files)
          ansible.builtin.find:
            paths: "/home/{{ target_user }}/{{ item.item }}"
            file_type: any
            hidden: true
            recurse: false
          loop: "{{ media_stat.results }}"
          when: item.stat.exists and item.stat.isdir
          register: media_find

        - name: Remove dirs if empty
          ansible.builtin.file:
            path: "/home/{{ target_user }}/{{ item.dir }}"
            state: absent
          loop: "{{ media_find.results }}"
          loop_control:
            label: "{{ item.item.item }}"
          vars:
            item_dir: "{{ item.item.item }}"
          when:
            - item is not skipped
            - item.matched | int == 0

    - name: Set GTK date format to ISO (YYYY-MM-DD)
      become: false
      ansible.builtin.command: >
        gsettings set org.gnome.desktop.interface clock-format '24h'
      changed_when: false

    - name: Ensure ISO-style date ordering via locale
      ansible.builtin.command: localectl set-locale LC_TIME=en_DK.UTF-8

    - name: Check Nemo gsettings schema exists
      become: false
      ansible.builtin.command: gsettings list-schemas
      register: gschemas
      changed_when: false

    - name: Set Nemo date format to ISO
      become: false
      ansible.builtin.command: >
        gsettings set org.nemo.preferences date-format 'iso'
      when: "'org.nemo.preferences' in gschemas.stdout_lines"
      changed_when: false


    - name: Install dotfiles (aliases)
      become: false
      vars:
        # Use the user who invoked sudo/ansible (important because play has become: true)
        target_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
        target_home: "{{ lookup('ansible.builtin.env', 'HOME') if (ansible_env.SUDO_USER is not defined) else '/home/' + target_user }}"

        # Put the managed file in the home folder (as you requested)
        aliases_dest: "{{ target_home }}/.bash_aliases"
      block:
        - name: Deploy bash aliases from repo to ~/.bash_aliases
          ansible.builtin.copy:
            src: "../files/dotfiles/bash_aliases"
            dest: "{{ aliases_dest }}"
            mode: "0644"

        - name: Ensure ~/.bashrc sources ~/.bash_aliases
          ansible.builtin.lineinfile:
            path: "{{ target_home }}/.bashrc"
            line: '[[ -f ~/.bash_aliases ]] && . ~/.bash_aliases'
            create: true
            state: present

        - name: Ensure ~/.zshrc sources ~/.bash_aliases (if you use zsh)
          ansible.builtin.lineinfile:
            path: "{{ target_home }}/.zshrc"
            line: '[[ -f ~/.bash_aliases ]] && source ~/.bash_aliases'
            create: true
            state: present

    - name: Ensure psutil is installed (Fedora)
      become: true
      ansible.builtin.dnf:
        name: python3-psutil
        state: present

    - name: Bind Ctrl+Alt+T to open terminal via custom keybinding (GNOME)
      become: true
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
      ansible.builtin.shell: |
        set -euo pipefail

        # Ensure custom0 (Nemo) stays registered and add custom1 (Terminal)
        gsettings set org.gnome.settings-daemon.plugins.media-keys custom-keybindings \
          "['/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/', \
            '/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom1/']"

        # Define custom1 = Terminal
        gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom1/ \
          name 'Terminal'
        gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom1/ \
          command 'gnome-terminal'
        gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom1/ \
          binding '<Control><Alt>t'
      args:
        executable: /bin/bash
      changed_when: false

    - name: Make Alt+Tab switch through windows (not apps) on GNOME
      become: false
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
      ansible.builtin.shell: |
        set -euo pipefail

        # Alt+Tab => switch windows
        gsettings set org.gnome.desktop.wm.keybindings switch-windows "['<Alt>Tab']"
        gsettings set org.gnome.desktop.wm.keybindings switch-windows-backward "['<Shift><Alt>Tab']"

        # Move app switching to Super+Tab (optional but recommended to avoid conflicts)
        gsettings set org.gnome.desktop.wm.keybindings switch-applications "['<Super>Tab']"
        gsettings set org.gnome.desktop.wm.keybindings switch-applications-backward "['<Shift><Super>Tab']"
      args:
        executable: /bin/bash
      changed_when: false

    - name: Check whether Nemo key open-new-window-focus exists
      become: false
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
      ansible.builtin.command: gsettings list-keys org.nemo.preferences
      register: nemo_pref_keys
      changed_when: false
      failed_when: false

    - name: Ensure Nemo opens new windows in foreground (only if supported)
      become: false
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
      ansible.builtin.command: gsettings set org.nemo.preferences open-new-window-focus true
      when: "'open-new-window-focus' in nemo_pref_keys.stdout_lines"
      changed_when: false

    - name: Install Vorta (Flatpak)
      community.general.flatpak:
        name: com.borgbase.Vorta
        state: present

    # ---- VS Code: configure user settings (hard-coded paths) + install extensions ----

    - name: Ensure VS Code user settings dir exists (RPM install path)
      become: true
      ansible.builtin.file:
        path: "/home/{{ ansible_env.SUDO_USER | default(ansible_user_id) }}/.config/Code/User"
        state: directory
        owner: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
        group: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
        mode: "0755"

    - name: Ensure VS Code user settings dir exists (Flatpak install path)
      become: true
      ansible.builtin.file:
        path: "/home/{{ ansible_env.SUDO_USER | default(ansible_user_id) }}/.var/app/com.visualstudio.code/config/Code/User"
        state: directory
        owner: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
        group: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
        mode: "0755"

    - name: Write VS Code settings.json (RPM path)
      become: true
      ansible.builtin.copy:
        dest: "/home/{{ ansible_env.SUDO_USER | default(ansible_user_id) }}/.config/Code/User/settings.json"
        owner: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
        group: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
        mode: "0644"
        content: |
          {
            "workbench.startupEditor": "none",
            "workbench.welcomePage.walkthroughs.openOnInstall": false,
            "workbench.tips.enabled": false,
            "update.showReleaseNotes": false,
            "telemetry.telemetryLevel": "off",
            "workbench.editor.enablePreview": false,
            "files.trimTrailingWhitespace": true,
            "editor.formatOnSave": true
          }

    - name: Write VS Code settings.json (Flatpak path)
      become: true
      ansible.builtin.copy:
        dest: "/home/{{ ansible_env.SUDO_USER | default(ansible_user_id) }}/.var/app/com.visualstudio.code/config/Code/User/settings.json"
        owner: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
        group: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
        mode: "0644"
        content: |
          {
            "workbench.startupEditor": "none",
            "workbench.welcomePage.walkthroughs.openOnInstall": false,
            "workbench.tips.enabled": false,
            "update.showReleaseNotes": false,
            "telemetry.telemetryLevel": "off",
            "workbench.editor.enablePreview": false,
            "files.trimTrailingWhitespace": true,
            "editor.formatOnSave": true
          }

    # ---- Extensions (install for both RPM + Flatpak best-effort) ----
    # Notes:
    # - "code" CLI works for RPM install (after first launch sometimes, but usually ok).
    # - Flatpak needs: flatpak run com.visualstudio.code ...
    # - We run both; whichever exists will succeed.

    - name: Install VS Code extensions (RPM "code" CLI) - best effort
      become: true
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
      ansible.builtin.shell: |
        set -euo pipefail
        if command -v code >/dev/null 2>&1; then
          code --install-extension ms-python.python --force
          code --install-extension ms-toolsai.jupyter --force
          code --install-extension ms-vscode.makefile-tools --force
          code --install-extension ms-azuretools.vscode-docker --force
          code --install-extension eamodio.gitlens --force
          code --install-extension streetsidesoftware.code-spell-checker --force
          code --install-extension yzhang.markdown-all-in-one --force
          code --install-extension davidanson.vscode-markdownlint --force
          code --install-extension redhat.vscode-yaml --force
          code --install-extension tamasfe.even-better-toml --force
          code --install-extension esbenp.prettier-vscode --force
          code --install-extension jnoortheen.nix-ide --force || true
        fi
      args:
        executable: /bin/bash
      failed_when: false
      changed_when: false

    - name: Install VS Code extensions (Flatpak) - best effort
      become: true
      become_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
      ansible.builtin.shell: |
        set -euo pipefail
        if command -v flatpak >/dev/null 2>&1; then
          # Only attempt if the app is installed
          if flatpak info com.visualstudio.code >/dev/null 2>&1; then
            flatpak run com.visualstudio.code --install-extension ms-python.python --force
            flatpak run com.visualstudio.code --install-extension ms-toolsai.jupyter --force
            flatpak run com.visualstudio.code --install-extension ms-vscode.makefile-tools --force
            flatpak run com.visualstudio.code --install-extension ms-azuretools.vscode-docker --force
            flatpak run com.visualstudio.code --install-extension eamodio.gitlens --force
            flatpak run com.visualstudio.code --install-extension streetsidesoftware.code-spell-checker --force
            flatpak run com.visualstudio.code --install-extension yzhang.markdown-all-in-one --force
            flatpak run com.visualstudio.code --install-extension davidanson.vscode-markdownlint --force
            flatpak run com.visualstudio.code --install-extension redhat.vscode-yaml --force
            flatpak run com.visualstudio.code --install-extension tamasfe.even-better-toml --force
            flatpak run com.visualstudio.code --install-extension esbenp.prettier-vscode --force
            flatpak run com.visualstudio.code --install-extension jnoortheen.nix-ide --force || true
          fi
        fi
      args:
        executable: /bin/bash
      failed_when: false
      changed_when: false
