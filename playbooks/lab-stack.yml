---
- name: Lab stack on Fedora (Quarto + Git + Docker + Apps)
  hosts: localhost
  connection: local
  become: true

  vars_files:
    - ../host_vars/localhost.yml

  vars:
    remove_system_sounds: true

    base_packages:
      - git
      - curl
      - wget
      - ca-certificates
      - tar
      - unzip
      - python3
      - python3-pip
      - dnf-plugins-core

    # Docker Engine (official packages, not Fedora's moby/podman defaults)
    docker_packages:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin

    quarto_version: "1.6.42"     # pin a version for reproducibility; bump intentionally
    quarto_install_dir: "/opt/quarto"
    quarto_tarball: "quarto-{{ quarto_version }}-linux-amd64.tar.gz"
    quarto_url: "https://github.com/quarto-dev/quarto-cli/releases/download/v{{ quarto_version }}/{{ quarto_tarball }}"

    # VS Code (vars)
    vscode_repo_name: "vscode"
    vscode_rpm_package: "code"
    vscode_flatpak_id: "com.visualstudio.code"

    remove_packages_best_effort:
      - deja-dup
      - aisleriot
      - evolution
      - nautilus-share
      - gnome-mahjongg
      - gnome-maps
      - gnome-mines
      - orca
      - gnome-sudoku
      - gnome-weather
      - transmission
      - gnome-calendar
      - gnome-bluetooth
      - brasero
      - cheese
      - vino
      - simple-scan
      - firefox
      - shotwell
      - gnome-todo
      - telnet

    install_packages_best_effort:
      - gimp
      - openssh-clients
      - openssh-server
      - gnome-commander
      - audacity
      - backintime-qt
      - recoll
      - libxslt
      - texstudio
      - texlive-scheme-full
      - texlive-latex-extra
      - texlive-xetex
      - texlive-lang-german
      - gitk
      - vim
      - clamav
      - python3-tkinter
      - pwgen
      - ruby
      - rubygem-bundler
      - xsel
      - diffpdf
      - dictd
      - dict-gcide
      - dict-wn
      - autokey-gtk
      - hplip
      - hplip-gui
      - gnome-clocks
      - artha
      - xournalpp
      - poppler-utils
      - antiword
      - wv
      - catdoc
      - perl-librdf
      - unrtf
      - untex
      - unifont-fonts
      - git-lfs
      - obs-studio
      - nextcloud-client
      - keepassxc
      - flatpak
      - pdfarranger
      - nemo
      - nemo-fileroller

    # Docker images to pull
    docker_images:
      - jbarlow83/ocrmypdf
      - rocker/tidyverse
      - rocker/verse
      - python:3
      - alekzonder/puppeteer
      - lfoppiano/grobid:0.8.1

  tasks:
    - name: Install baseline packages
      ansible.builtin.dnf:
        name: "{{ base_packages }}"
        state: present
        update_cache: true

    # ---- Remove “unwanted” packages ----
    - name: Remove unwanted packages
      ansible.builtin.dnf:
        name: "{{ item }}"
        state: absent
      loop: "{{ remove_packages_best_effort }}"
      register: remove_pkgs_result
      failed_when: false

    # ---- Install “wanted” packages ----
    - name: Install desired packages
      ansible.builtin.dnf:
        name: "{{ item }}"
        state: present
      loop: "{{ install_packages_best_effort }}"
      register: install_pkgs_result
      failed_when: false

    # ---- Docker: avoid conflicts with docker CLI shim from Podman ----
    - name: Remove podman-docker (conflicts with Docker CE CLI)
      ansible.builtin.dnf:
        name: podman-docker
        state: absent
      failed_when: false

    # ---- Docker Engine from Docker repo ----
    - name: Add Docker CE repo
      ansible.builtin.command: dnf config-manager addrepo --from-repofile https://download.docker.com/linux/fedora/docker-ce.repo
      args:
        creates: /etc/yum.repos.d/docker-ce.repo

    - name: Install Docker Engine packages
      ansible.builtin.dnf:
        name: "{{ docker_packages }}"
        state: present
        update_cache: true

    - name: Enable and start Docker service
      ansible.builtin.systemd:
        name: docker
        enabled: true
        state: started

    - name: Ensure docker group exists
      ansible.builtin.group:
        name: docker
        state: present

    - name: Add lab user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        groups: docker
        append: true

    - name: Note about docker group membership
      ansible.builtin.debug:
        msg: "You may need to log out/in (or run: newgrp docker) for docker without sudo."

    # ---- Git config (kept minimal as in your playbook) ----
    - name: Configure Git identity (global)
      become: false
      block:
        - name: git push.autoSetupRemote
          community.general.git_config:
            name: push.autoSetupRemote
            scope: global
            value: "true"

    # ---- Quarto install (tarball -> /opt/quarto) ----
    - name: Remove /opt/quarto if it exists as a directory (to allow symlink)
      ansible.builtin.file:
        path: "{{ quarto_install_dir }}"
        state: absent
      when: quarto_install_dir is defined

    - name: Download Quarto tarball
      ansible.builtin.get_url:
        url: "{{ quarto_url }}"
        dest: "/tmp/{{ quarto_tarball }}"
        mode: "0644"

    - name: Unpack Quarto to /opt
      ansible.builtin.unarchive:
        src: "/tmp/{{ quarto_tarball }}"
        dest: "/opt"
        remote_src: true

    - name: Symlink /opt/quarto -> extracted folder
      ansible.builtin.file:
        src: "/opt/quarto-{{ quarto_version }}"
        dest: "{{ quarto_install_dir }}"
        state: link
        force: true

    - name: Add Quarto to system PATH
      ansible.builtin.copy:
        dest: /etc/profile.d/quarto.sh
        mode: "0644"
        content: |
          export PATH={{ quarto_install_dir }}/bin:$PATH

    # ---- Chrome (official repo) ----
    - name: Import Google Linux signing key (RPM)
      ansible.builtin.rpm_key:
        state: present
        key: https://dl.google.com/linux/linux_signing_key.pub

    - name: Add Google Chrome yum repo
      ansible.builtin.yum_repository:
        name: google-chrome
        description: google-chrome
        baseurl: https://dl.google.com/linux/chrome/rpm/stable/x86_64
        enabled: true
        gpgcheck: true
        gpgkey: https://dl.google.com/linux/linux_signing_key.pub

    - name: Install Google Chrome
      ansible.builtin.dnf:
        name: google-chrome-stable
        state: present
        update_cache: true

    # ---- VS Code (Microsoft RPM repo, fallback to Flatpak) ----
    - name: Import Microsoft signing key (RPM)
      ansible.builtin.rpm_key:
        state: present
        key: https://packages.microsoft.com/keys/microsoft.asc

    - name: Add VS Code yum repo
      ansible.builtin.yum_repository:
        name: "{{ vscode_repo_name }}"
        description: "Visual Studio Code"
        baseurl: https://packages.microsoft.com/yumrepos/vscode
        enabled: true
        gpgcheck: true
        gpgkey: https://packages.microsoft.com/keys/microsoft.asc

    - name: Try to install VS Code via dnf
      ansible.builtin.dnf:
        name: "{{ vscode_rpm_package }}"
        state: present
        update_cache: true
      register: vscode_dnf
      failed_when: false

    - name: Install VS Code via Flatpak (fallback)
      community.general.flatpak:
        name: "{{ vscode_flatpak_id }}"
        state: present
      when: vscode_dnf is failed


    - name: Set VS Code as default editor for common text formats
      become: false
      ansible.builtin.shell: |
        xdg-mime default code.desktop text/plain
        xdg-mime default code.desktop text/markdown
        xdg-mime default code.desktop text/x-python
        xdg-mime default code.desktop application/x-quarto


    # ---- Flatpak + Flathub (needed for reliable Thunderbird/ownCloud fallback) ----
    - name: Ensure Flathub remote exists
      community.general.flatpak_remote:
        name: flathub
        state: present
        flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo

    # --- ownCloud client (prefer dnf, fallback to Flatpak) ---
    - name: Try to install ownCloud client via dnf
      ansible.builtin.dnf:
        name: owncloud-client
        state: present
      register: owncloud_dnf
      failed_when: false

    - name: Install ownCloud client via Flatpak (fallback)
      community.general.flatpak:
        name: com.owncloud.desktopclient.ownCloud
        state: present
      when: owncloud_dnf is failed

    # ---- Thunderbird (dnf if available, otherwise Flatpak) ----
    - name: Try to install Thunderbird via dnf
      ansible.builtin.dnf:
        name: thunderbird
        state: present
      register: thunderbird_dnf
      failed_when: false

    - name: Install Thunderbird via Flatpak (fallback)
      community.general.flatpak:
        name: org.mozilla.Thunderbird
        state: present
      when: thunderbird_dnf is failed

    - name: Install Obsidian (Flatpak)
      community.general.flatpak:
        name: md.obsidian.Obsidian
        state: present

    - name: Ensure Nemo desktop file exists (sanity check)
      ansible.builtin.stat:
        path: /usr/share/applications/nemo.desktop
      register: nemo_desktop

    - name: Set Nemo as default handler for directories (xdg-mime)
      become: false
      ansible.builtin.command: xdg-mime default nemo.desktop inode/directory
      when: nemo_desktop.stat.exists
      changed_when: false

    - name: Set Nemo as default handler for folder scheme (xdg-mime)
      become: false
      ansible.builtin.command: xdg-mime default nemo.desktop x-scheme-handler/file
      when: nemo_desktop.stat.exists
      changed_when: false

    - name: Create custom keybinding to open Nemo (Super+E)
      become: false
      ansible.builtin.shell: |
        gsettings set org.gnome.settings-daemon.plugins.media-keys custom-keybindings "['/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/']"
        gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/ name 'Files (Nemo)'
        gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/ command 'nemo'
        gsettings set org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom0/ binding '<Super>e'
      args:
        executable: /bin/bash
      changed_when: false

    # ---- Nemo sane defaults (list view, sorting, dates) ----
    - name: Configure Nemo preferences
      become: false
      vars:
        nemo_settings:
          - { key: "sort-directories-first", value: "true" }
          - { key: "default-sort-order", value: "'name'" }
          - { key: "default-sort-in-reverse-order", value: "false" }
          - { key: "show-full-path-titles", value: "true" }
          - { key: "default-folder-viewer", value: "'list-view'" }
      ansible.builtin.command: >
        gsettings set org.nemo.preferences {{ item.key }} {{ item.value }}
      loop: "{{ nemo_settings }}"
      changed_when: false


    # ---- Optional: remove system sounds (destructive) ----
    - name: Remove system sounds (/usr/share/sounds) - optional and destructive
      ansible.builtin.file:
        path: /usr/share/sounds
        state: absent
      when: remove_system_sounds | bool

    # ---- Docker pulls ----
    - name: Pull docker images
      ansible.builtin.command: "docker pull {{ item }}"
      loop: "{{ docker_images }}"
      register: docker_pull_result
      changed_when: false

    # ---- GUI-session-only items ----
    - name: Mouse speed note (xset requires an active X/Wayland session)
      ansible.builtin.debug:
        msg: "Mouse speed change (xset m 2/1 10) is session-specific; do it in your desktop session, not via Ansible."

    - name: Remove default media dirs in home if empty
      become: false
      vars:
        target_user: "{{ lab_user.name | default(ansible_user_id) }}"
        media_dirs: [Music, Pictures, Videos]
      block:
        - name: Check whether each dir exists
          ansible.builtin.stat:
            path: "/home/{{ target_user }}/{{ item }}"
          loop: "{{ media_dirs }}"
          register: media_stat

        - name: Count entries inside each dir (including hidden files)
          ansible.builtin.find:
            paths: "/home/{{ target_user }}/{{ item.item }}"
            file_type: any
            hidden: true
            recurse: false
          loop: "{{ media_stat.results }}"
          when: item.stat.exists and item.stat.isdir
          register: media_find

        - name: Remove dirs if empty
          ansible.builtin.file:
            path: "/home/{{ target_user }}/{{ item.dir }}"
            state: absent
          loop: "{{ media_find.results }}"
          loop_control:
            label: "{{ item.item.item }}"
          vars:
            item_dir: "{{ item.item.item }}"
          when:
            - item is not skipped
            - item.matched | int == 0

    - name: Set GTK date format to ISO (YYYY-MM-DD)
      become: false
      ansible.builtin.command: >
        gsettings set org.gnome.desktop.interface clock-format '24h'
      changed_when: false

    - name: Ensure ISO-style date ordering via locale
      ansible.builtin.command: localectl set-locale LC_TIME=en_DK.UTF-8

    - name: Check Nemo gsettings schema exists
      become: false
      ansible.builtin.command: gsettings list-schemas
      register: gschemas
      changed_when: false

    - name: Set Nemo date format to ISO
      become: false
      ansible.builtin.command: >
        gsettings set org.nemo.preferences date-format 'iso'
      when: "'org.nemo.preferences' in gschemas.stdout_lines"
      changed_when: false
